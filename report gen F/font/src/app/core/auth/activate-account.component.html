<div class="activation-container">
  <div *ngIf="loading" class="loading-section">
    <h2>Activating Account...</h2>
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="error && !loading" class="error-section">
    <h2 style="color: red">{{ error }}</h2>
    <button mat-raised-button color="primary" (click)="goToLogin()">
      Go to Login
    </button>
  </div>

  <div *ngIf="message && !loading && !error" class="success-section">
    <h2 style="color: green">{{ message }}</h2>
    <p>Redirecting to login page...</p>
  </div>

  <!-- Activation Code Form -->
  <div *ngIf="email && !loading && !error && !message && !showPasswordSetup" class="activation-form-section">
    <h2>Account Activation</h2>
    <p>{{ message || `Please enter the 6-digit activation code sent to ${email}` }}</p>
    
    <form [formGroup]="activationForm" (ngSubmit)="onSubmit()">
      <mat-form-field appearance="outline">
        <mat-label>Activation Code</mat-label>
        <input 
          matInput 
          formControlName="activationCode" 
          maxlength="6"
          placeholder="123456"
        />
        <mat-error *ngIf="activationForm.get('activationCode')?.invalid && activationForm.get('activationCode')?.touched">
          6-digit activation code is required
        </mat-error>
      </mat-form-field>

      <div class="button-group">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit" 
          [disabled]="isSubmitting || activationForm.invalid"
        >
          {{ isSubmitting ? 'Verifying...' : 'Verify Code' }}
        </button>
        
        <button 
          mat-stroked-button 
          type="button" 
          (click)="resendActivationCode()"
          [disabled]="isSubmitting"
        >
          Resend Code
        </button>
      </div>
    </form>
  </div>

  <!-- Password Setup Form -->
  <div *ngIf="showPasswordSetup && !loading && !error" class="password-setup-section">
    <h2>Complete Account Setup</h2>
    <p>{{ message }}</p>
    
    <form [formGroup]="passwordSetupForm" (ngSubmit)="onSubmit()">
      <!-- Activation Code Input (only show if user came from email link) -->
      <mat-form-field appearance="outline" *ngIf="!activationCode">
        <mat-label>Activation Code</mat-label>
        <input 
          matInput 
          formControlName="activationCode" 
          maxlength="6"
          placeholder="123456"
        />
        <mat-error *ngIf="passwordSetupForm.get('activationCode')?.invalid && passwordSetupForm.get('activationCode')?.touched">
          6-digit activation code is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Password</mat-label>
        <input 
          matInput 
          [type]="hidePassword ? 'password' : 'text'"
          formControlName="password" 
          placeholder="Enter your password"
        />
        <button 
          mat-icon-button 
          matSuffix 
          type="button"
          (click)="togglePasswordVisibility()"
          [attr.aria-label]="'Hide password'"
          [attr.aria-pressed]="hidePassword">
          <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-error *ngIf="passwordSetupForm.get('password')?.invalid && passwordSetupForm.get('password')?.touched">
          Password must be at least 8 characters long
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Confirm Password</mat-label>
        <input 
          matInput 
          [type]="hideConfirmPassword ? 'password' : 'text'"
          formControlName="confirmPassword" 
          placeholder="Confirm your password"
        />
        <button 
          mat-icon-button 
          matSuffix 
          type="button"
          (click)="toggleConfirmPasswordVisibility()"
          [attr.aria-label]="'Hide confirm password'"
          [attr.aria-pressed]="hideConfirmPassword">
          <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-error *ngIf="passwordSetupForm.get('confirmPassword')?.hasError('passwordMismatch') && passwordSetupForm.get('confirmPassword')?.touched">
          Passwords do not match
        </mat-error>
        <mat-error *ngIf="passwordSetupForm.get('confirmPassword')?.invalid && passwordSetupForm.get('confirmPassword')?.touched && !passwordSetupForm.get('confirmPassword')?.hasError('passwordMismatch')">
          Please confirm your password
        </mat-error>
      </mat-form-field>

      <div class="button-group">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit" 
          [disabled]="isSubmitting || passwordSetupForm.invalid"
        >
          {{ isSubmitting ? 'Setting up...' : 'Complete Setup' }}
        </button>
      </div>
    </form>
  </div>
</div>